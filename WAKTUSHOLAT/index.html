<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal Sholat Digital Premium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary-emerald: #059669;
            --secondary-emerald: #10b981;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }

        .prayer-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .prayer-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 10px 20px rgba(5, 150, 105, 0.1);
        }

        .active-prayer-card {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white !important;
            box-shadow: 0 15px 30px rgba(5, 150, 105, 0.2);
        }

        .active-prayer-card span, .active-prayer-card i {
            color: white !important;
        }

        .compass-container {
            position: relative;
            width: 260px;
            height: 260px;
            border-radius: 50%;
            background: radial-gradient(circle, #ffffff 0%, #f8fafc 100%);
            border: 12px solid #ffffff;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.1), 0 10px 25px rgba(0,0,0,0.05);
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: border-color 0.5s ease;
        }

        .compass-disk {
            position: absolute;
            width: 100%;
            height: 100%;
            transition: transform 0.1s ease-out;
        }

        .compass-arrow {
            position: absolute;
            width: 4px;
            height: 100px;
            background: linear-gradient(to bottom, #ef4444 50%, #cbd5e1 50%);
            border-radius: 4px;
            z-index: 10;
        }

        .kiblat-marker-wrapper {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 20;
            pointer-events: none;
        }

        .kiblat-icon {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            color: #059669;
            font-size: 2rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .nav-tab {
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            color: #059669;
            border-bottom: 3px solid #059669;
        }

        @keyframes pulse-soft {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        .pulse {
            animation: pulse-soft 2s infinite ease-in-out;
        }

        .accuracy-indicator {
            font-size: 10px;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 10px;
            margin-top: 10px;
            display: inline-block;
        }
    </style>
</head>
<body class="pb-24">

    <!-- Hero Header -->
    <div class="bg-emerald-800 text-white pt-10 pb-20 px-6 rounded-b-[3rem] shadow-2xl relative overflow-hidden">
        <div class="absolute top-0 right-0 opacity-10 transform translate-x-10 -translate-y-10">
            <i class="fas fa-mosque text-[15rem]"></i>
        </div>
        
        <div class="max-w-md mx-auto relative z-10 text-center">
            <div class="flex justify-between items-start mb-6">
                <div class="text-left">
                    <p id="current-date" class="text-emerald-200 text-sm font-medium">Memuat tanggal...</p>
                    <h1 class="text-3xl font-extrabold tracking-tight">Assalamu'alaikum</h1>
                </div>
                <div class="bg-white/20 backdrop-blur-md p-2 rounded-2xl">
                    <i class="fas fa-bell text-xl"></i>
                </div>
            </div>

            <div class="mt-8">
                <p class="text-emerald-100 text-xs uppercase tracking-[0.2em] font-bold mb-1">Menuju Waktu</p>
                <h2 id="next-prayer-name" class="text-5xl font-black mb-2">-</h2>
                <div id="countdown" class="text-2xl font-mono bg-black/20 inline-block px-4 py-1 rounded-full backdrop-blur-sm">
                    00:00:00
                </div>
            </div>

            <div class="mt-6 flex items-center justify-center gap-2 text-emerald-100 bg-emerald-900/40 w-fit mx-auto px-4 py-2 rounded-full backdrop-blur-md border border-white/10">
                <i class="fas fa-location-dot"></i>
                <span id="location-text" class="text-sm font-semibold italic">Mendeteksi lokasi...</span>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <main class="max-w-md mx-auto px-6 -mt-10 relative z-20">
        
        <!-- Tab Navigation -->
        <div class="glass-card rounded-2xl p-2 flex mb-6 shadow-xl">
            <button onclick="switchTab('jadwal')" id="tab-jadwal" class="nav-tab active flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2">
                <i class="fas fa-calendar-alt"></i> Jadwal
            </button>
            <button onclick="switchTab('kiblat')" id="tab-kiblat" class="nav-tab flex-1 py-3 text-sm font-bold text-gray-400 flex items-center justify-center gap-2">
                <i class="fas fa-compass"></i> Kiblat
            </button>
        </div>

        <!-- Section: Jadwal -->
        <div id="section-jadwal" class="space-y-4">
            <div class="flex justify-between items-center mb-2 px-1">
                <h3 class="font-bold text-slate-800">Waktu Sholat Hari Ini</h3>
                <span id="current-time" class="text-emerald-600 font-bold bg-emerald-50 px-3 py-1 rounded-lg text-sm">00:00:00</span>
            </div>
            
            <div id="prayer-list" class="space-y-3">
                <div class="animate-pulse space-y-3">
                    <div class="h-16 bg-white/50 rounded-2xl"></div>
                    <div class="h-16 bg-white/50 rounded-2xl"></div>
                    <div class="h-16 bg-white/50 rounded-2xl"></div>
                </div>
            </div>
        </div>

        <!-- Section: Kiblat -->
        <div id="section-kiblat" class="hidden animate-fadeIn">
            <div class="glass-card rounded-[2.5rem] p-8 text-center">
                <h3 class="font-extrabold text-slate-800 text-xl mb-6">Penunjuk Arah Kiblat</h3>
                
                <div class="compass-container" id="compass-outer">
                    <div class="compass-disk" id="compass-disk">
                        <!-- Cardinal Points inside the disk -->
                        <span class="absolute top-4 left-1/2 -translate-x-1/2 text-[12px] font-black text-slate-400">U</span>
                        <span class="absolute bottom-4 left-1/2 -translate-x-1/2 text-[12px] font-black text-slate-400">S</span>
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-[12px] font-black text-slate-400">B</span>
                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-[12px] font-black text-slate-400">T</span>
                        
                        <!-- Static North Arrow on Disk -->
                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 compass-arrow"></div>
                    </div>

                    <!-- Fixed Kiblat Marker relative to North -->
                    <div class="kiblat-marker-wrapper" id="kiblat-wrapper">
                        <div class="kiblat-icon">
                            <i class="fas fa-kaaba"></i>
                        </div>
                    </div>
                </div>

                <div id="accuracy-box" class="accuracy-indicator bg-slate-100 text-slate-500 mt-4">
                    Menunggu Sensor...
                </div>

                <div class="bg-slate-50 rounded-2xl p-4 block mt-4 mb-6 border border-slate-100">
                    <p id="qibla-degree" class="text-sm font-bold text-slate-600 tracking-wide">Mendeteksi koordinat...</p>
                </div>

                <button onclick="requestCompassPermission()" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold hover:bg-slate-800 transition shadow-lg shadow-slate-200 flex items-center justify-center gap-3">
                    <i class="fas fa-sync-alt"></i> Kalibrasi Kompas
                </button>
                <p class="text-[10px] text-slate-400 mt-4 leading-relaxed px-4">
                    Pegang perangkat dalam posisi horizontal (rata). Jauhkan dari benda logam atau magnet untuk akurasi maksimal.
                </p>
            </div>
        </div>

    </main>

    <!-- Modal Notifikasi -->
    <div id="notification-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-50 p-6">
        <div class="bg-white rounded-[3rem] p-10 text-center max-w-xs w-full shadow-2xl transform scale-110">
            <div class="w-24 h-24 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl pulse">
                <i class="fas fa-mosque"></i>
            </div>
            <h2 class="text-2xl font-black text-slate-800 mb-2">Waktunya Sholat</h2>
            <p id="modal-prayer-name" class="text-emerald-600 font-bold mb-8 text-xl tracking-widest uppercase"></p>
            <button onclick="closeModal()" class="w-full py-4 bg-emerald-600 text-white rounded-2xl font-extrabold shadow-xl shadow-emerald-200 hover:bg-emerald-700 transition">
                Selesai
            </button>
        </div>
    </div>

    <script>
        let prayerTimes = {};
        let qiblaAngle = 0; // True Qibla angle from North
        let coords = { lat: 0, lng: 0 };
        let currentHeading = 0;

        window.onload = () => {
            updateTime();
            setInterval(updateTime, 1000);
            getLocation();
        };

        function switchTab(tab) {
            const jadwalSection = document.getElementById('section-jadwal');
            const kiblatSection = document.getElementById('section-kiblat');
            const tabJadwalBtn = document.getElementById('tab-jadwal');
            const tabKiblatBtn = document.getElementById('tab-kiblat');

            if (tab === 'jadwal') {
                jadwalSection.classList.remove('hidden');
                kiblatSection.classList.add('hidden');
                tabJadwalBtn.classList.add('active');
                tabJadwalBtn.classList.remove('text-gray-400');
                tabKiblatBtn.classList.remove('active');
                tabKiblatBtn.classList.add('text-gray-400');
            } else {
                jadwalSection.classList.add('hidden');
                kiblatSection.classList.remove('hidden');
                tabKiblatBtn.classList.add('active');
                tabKiblatBtn.classList.remove('text-gray-400');
                tabJadwalBtn.classList.remove('active');
                tabJadwalBtn.classList.add('text-gray-400');
            }
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').innerText = now.toLocaleTimeString('id-ID', { hour12: false });
            document.getElementById('current-date').innerText = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            if (Object.keys(prayerTimes).length > 0) {
                updateCountdown();
            }
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    coords.lat = position.coords.latitude;
                    coords.lng = position.coords.longitude;
                    fetchPrayerTimes();
                }, error => {
                    document.getElementById('location-text').innerText = "Gagal lokasi. Default: Jakarta";
                    coords.lat = -6.2088;
                    coords.lng = 106.8456;
                    fetchPrayerTimes();
                });
            }
        }

        async function fetchPrayerTimes() {
            try {
                const date = new Date();
                const timestamp = Math.floor(date.getTime() / 1000);
                
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords.lat}&lon=${coords.lng}`)
                    .then(r => r.json())
                    .then(data => {
                        const city = data.address.city || data.address.town || data.address.state || "Lokasi Anda";
                        document.getElementById('location-text').innerText = city;
                    });

                const res = await fetch(`https://api.aladhan.com/v1/timings/${timestamp}?latitude=${coords.lat}&longitude=${coords.lng}&method=11`);
                const data = await res.json();
                prayerTimes = data.data.timings;

                // Hitung Sudut Kiblat secara akurat menggunakan rumus Great Circle
                const phiK = 21.4225 * Math.PI / 180; // Latitude Mekkah
                const lambdaK = 39.8262 * Math.PI / 180; // Longitude Mekkah
                const phi = coords.lat * Math.PI / 180;
                const lambda = coords.lng * Math.PI / 180;

                const y = Math.sin(lambdaK - lambda);
                const x = Math.cos(phi) * Math.tan(phiK) - Math.sin(phi) * Math.cos(lambdaK - lambda);
                qiblaAngle = Math.atan2(y, x) * 180 / Math.PI;
                if (qiblaAngle < 0) qiblaAngle += 360;

                document.getElementById('qibla-degree').innerText = `Kiblat: ${Math.round(qiblaAngle)}Â° dari Utara`;
                document.getElementById('kiblat-wrapper').style.transform = `rotate(${qiblaAngle}deg)`;

                renderPrayerList();
            } catch (err) {
                console.error(err);
            }
        }

        function renderPrayerList() {
            const list = document.getElementById('prayer-list');
            const displayPrayers = { 'Fajr': 'Subuh', 'Dhuhr': 'Dzuhur', 'Asr': 'Ashar', 'Maghrib': 'Maghrib', 'Isha': 'Isya' };

            let html = '';
            for (const [key, label] of Object.entries(displayPrayers)) {
                html += `
                    <div id="card-${key}" class="prayer-card glass-card flex justify-between items-center p-5 rounded-[1.5rem] border-transparent">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-emerald-50 flex items-center justify-center text-emerald-600 text-lg shadow-sm">
                                <i class="fas ${getIcon(key)}"></i>
                            </div>
                            <span class="font-bold text-slate-700 tracking-tight">${label}</span>
                        </div>
                        <span class="font-mono text-xl font-black text-slate-800">${prayerTimes[key]}</span>
                    </div>
                `;
            }
            list.innerHTML = html;
        }

        function getIcon(key) {
            const icons = { 'Fajr': 'fa-cloud-sun', 'Dhuhr': 'fa-sun', 'Asr': 'fa-cloud', 'Maghrib': 'fa-moon-astronomy', 'Isha': 'fa-star' };
            return icons[key] || 'fa-clock';
        }

        function updateCountdown() {
            const now = new Date();
            const prayerKeys = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
            let nextPrayer = null;
            let minDiff = Infinity;

            prayerKeys.forEach(key => {
                const [h, m] = prayerTimes[key].split(':');
                const pDate = new Date();
                pDate.setHours(h, m, 0);

                if (pDate > now && (pDate - now) < minDiff) {
                    minDiff = pDate - now;
                    nextPrayer = { name: key, time: pDate };
                }

                if (Math.abs(pDate - now) < 2000) {
                    triggerAlarm(key);
                }
            });

            if (!nextPrayer) {
                const [h, m] = prayerTimes['Fajr'].split(':');
                const pDate = new Date();
                pDate.setDate(pDate.getDate() + 1);
                pDate.setHours(h, m, 0);
                nextPrayer = { name: 'Fajr', time: pDate };
                minDiff = pDate - now;
            }

            const displayNames = { 'Fajr': 'Subuh', 'Dhuhr': 'Dzuhur', 'Asr': 'Ashar', 'Maghrib': 'Maghrib', 'Isha': 'Isya' };
            document.getElementById('next-prayer-name').innerText = displayNames[nextPrayer.name];
            
            document.querySelectorAll('.prayer-card').forEach(el => el.classList.remove('active-prayer-card'));
            const activeCard = document.getElementById(`card-${nextPrayer.name}`);
            if(activeCard) activeCard.classList.add('active-prayer-card');

            const h = Math.floor(minDiff / 3600000);
            const m = Math.floor((minDiff % 3600000) / 60000);
            const s = Math.floor((minDiff % 60000) / 1000);
            document.getElementById('countdown').innerText = 
                `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        let alarmDebounce = false;
        function triggerAlarm(name) {
            if(alarmDebounce) return;
            alarmDebounce = true;
            document.getElementById('modal-prayer-name').innerText = name;
            document.getElementById('notification-modal').style.display = 'flex';
            if (navigator.vibrate) navigator.vibrate([300, 100, 300]);
            setTimeout(() => alarmDebounce = false, 60000);
        }

        function closeModal() {
            document.getElementById('notification-modal').style.display = 'none';
        }

        // --- ENHANCED COMPASS LOGIC ---
        function requestCompassPermission() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation, true);
                        } else {
                            alert("Izin sensor ditolak.");
                        }
                    })
                    .catch(console.error);
            } else {
                window.addEventListener('deviceorientation', handleOrientation, true);
            }
        }

        function handleOrientation(event) {
            let heading = 0;
            const accuracyBox = document.getElementById('accuracy-box');

            // iOS support
            if (event.webkitCompassHeading) {
                heading = event.webkitCompassHeading;
                accuracyBox.innerText = "Status: Akurat (iOS)";
                accuracyBox.className = "accuracy-indicator bg-emerald-100 text-emerald-600 mt-4";
            } 
            // Android / Standard support
            else if (event.alpha !== null) {
                // Alpha biasanya relatif terhadap tempat mulai, tapi jika absolute true maka ke Utara
                heading = 360 - event.alpha; 
                accuracyBox.innerText = "Status: Aktif (Kalibrasi...)";
                accuracyBox.className = "accuracy-indicator bg-amber-100 text-amber-600 mt-4";
            }

            if (heading !== 0) {
                const disk = document.getElementById('compass-disk');
                const outer = document.getElementById('compass-outer');
                
                // Putar piringan kompas agar Utara selalu ke arah Utara sebenarnya
                disk.style.transform = `rotate(${-heading}deg)`;
                
                // Sudut relatif Kiblat terhadap orientasi HP saat ini
                const relativeQibla = (qiblaAngle - heading + 360) % 360;

                // Feedback visual jika sudah mendekati arah kiblat (toleransi 5 derajat)
                if (relativeQibla < 5 || relativeQibla > 355) {
                    outer.style.borderColor = "#059669";
                    outer.classList.add('pulse');
                    accuracyBox.innerText = "ARAH KIBLAT TEPAT";
                    accuracyBox.className = "accuracy-indicator bg-emerald-500 text-white mt-4 shadow-lg";
                } else {
                    outer.style.borderColor = "#ffffff";
                    outer.classList.remove('pulse');
                }
            }
        }
    </script>
</body>
</html>
